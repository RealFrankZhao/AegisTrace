# AEGISTRACE 完整测试步骤

## 第一步：基本测试（已完成 ✅）

你已经运行了 `./scripts/test_basic.sh`，所有基本检查都通过了。

## 第二步：启动 GUI 应用

### 在终端中运行：

```bash
cd apps/aegis-tauri
cargo tauri dev
```

**预期结果**：
- 编译过程会显示进度
- 编译完成后，会弹出一个 GUI 窗口
- 窗口标题应该是 "AEGISTRACE"
- 界面显示 "Start Session" 按钮

## 第三步：GUI 功能测试

### 测试场景 1：基本录制（5-10 秒）

1. **检查初始状态**
   - 点击 "Refresh Status" 按钮
   - 应该显示：`Status: idle`
   - `Session dir: -`

2. **开始录制**
   - 点击 "Start Session" 按钮
   - 等待 1-2 秒
   - 状态应该变为：`Status: running`
   - `Session dir:` 应该显示一个路径（如 `/Users/frankzhao/Downloads/Evidence_20250103_143022`）
   - 终端可能会显示：`Added video segment 1 (size: ... bytes)`

3. **等待录制**
   - 等待 5-10 秒（让录屏有时间生成内容）

4. **停止录制**
   - 点击 "Stop Session" 按钮
   - 等待 3-5 秒（文件处理需要时间）
   - 状态应该变回：`Status: idle`
   - 终端可能会显示处理信息

### 测试场景 2：验证证据包

#### 方法 1：使用测试脚本（推荐）

```bash
# 在项目根目录运行
cd /Users/frankzhao/Documents/Github/AEGISTRACE
./scripts/test_evidence_bundle.sh
```

#### 方法 2：手动验证

```bash
# 1. 查找最新生成的证据包
ls -lt ~/Downloads/Evidence_* | head -1

# 2. 查看证据包内容
ls -lh ~/Downloads/Evidence_YYYYMMDD_HHMMSS/

# 应该看到：
# - session.json
# - events.jsonl
# - manifest.json
# - files/ 目录

# 3. 检查视频文件
ls -lh ~/Downloads/Evidence_*/files/screen_*.mov

# 4. 运行验证器
cargo run -p aegis-verifier -- verify ~/Downloads/Evidence_YYYYMMDD_HHMMSS
```

**预期结果**：
- ✅ 验证器输出 `PASS`
- ✅ 至少有一个视频文件（screen_1_*.mov）
- ✅ 视频文件大小 > 0

## 第四步：性能测试

### 测试 1：启动速度

```bash
# 测量启动时间
time cargo tauri dev
```

**目标**：< 3 秒

### 测试 2：停止响应速度

1. 启动会话
2. 点击停止
3. 观察从点击到状态变为 `idle` 的时间

**目标**：< 5 秒

### 测试 3：多次启动/停止

重复以下操作 3-5 次：
1. 启动会话
2. 等待 3 秒
3. 停止会话
4. 等待 2 秒

**验证**：
- 每次都能正常启动/停止
- 没有错误信息
- 每个会话都有独立的证据包

## 第五步：检查日志

### 查看终端输出

运行 `cargo tauri dev` 时，终端会显示：

```
Added video segment 1 (size: 1234567 bytes)
Added video segment 2 (size: 2345678 bytes)
```

### 检查错误

如果有问题，查看：
- 终端中的错误信息（红色文字）
- 是否有 "Warning" 或 "Error" 消息

## 常见问题排查

### 问题 1：GUI 窗口没有打开

**检查**：
```bash
# 查看是否有编译错误
cd apps/aegis-tauri
cargo check
```

### 问题 2：点击 "Start Session" 没有反应

**检查**：
1. 查看终端是否有错误信息
2. 检查录屏工具是否存在：
   ```bash
   ls -la collectors/macos/native_recorder/.build/release/aegis-native-recorder
   ```
3. 如果没有，构建它：
   ```bash
   cd collectors/macos/native_recorder
   swift build -c release
   ```

### 问题 3：没有生成视频文件

**检查**：
1. macOS 屏幕录制权限：
   - 系统设置 → 安全性与隐私 → 屏幕录制
   - 确保终端或应用有权限
2. 查看终端日志，是否有错误
3. 检查临时文件：
   ```bash
   ls -la /tmp/aegis_screen_*
   ```

### 问题 4：验证器失败

**检查**：
```bash
# 运行验证器查看详细错误
cargo run -p aegis-verifier -- verify ~/Downloads/Evidence_*

# 检查文件是否完整
ls -la ~/Downloads/Evidence_*/
cat ~/Downloads/Evidence_*/events.jsonl
```

## 测试检查清单

完成以下检查：

- [ ] GUI 应用可以启动
- [ ] 可以开始会话
- [ ] 状态正确更新（idle → running）
- [ ] 可以停止会话
- [ ] 状态正确更新（running → idle）
- [ ] 证据包已创建
- [ ] 验证器测试通过（PASS）
- [ ] 视频文件存在
- [ ] 视频文件大小 > 0
- [ ] 多次启动/停止正常

## 快速测试命令总结

```bash
# 1. 基本检查
./scripts/test_basic.sh

# 2. 启动应用
cd apps/aegis-tauri && cargo tauri dev

# 3. （在 GUI 中测试后）验证证据包
cd ../.. && ./scripts/test_evidence_bundle.sh

# 4. 手动验证
cargo run -p aegis-verifier -- verify ~/Downloads/Evidence_*
```

## 下一步

如果所有测试都通过，你可以：
1. 测试更长的录制（1-2 分钟）
2. 测试分段功能（录制超过 10 分钟）
3. 检查性能指标（CPU、内存占用）
