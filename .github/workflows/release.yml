name: release

on:
  push:
    tags:
      - "v*"

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build Rust binaries
        run: cargo build --release -p aegis-core-server -p aegis-collector-cli -p aegis-verifier
      - name: Build native recorder
        run: |
          cd collectors/macos/native_recorder
          swift build -c release
      - name: Package
        run: |
          mkdir -p dist/macos
          cp target/release/aegis-core-server dist/macos/
          cp target/release/aegis-collector-cli dist/macos/
          cp target/release/aegis-verifier dist/macos/
          if [ -f collectors/macos/native_recorder/.build/release/aegis-native-recorder ]; then
            cp collectors/macos/native_recorder/.build/release/aegis-native-recorder dist/macos/
          else
            echo "Warning: aegis-native-recorder not found, skipping..."
          fi
          bash scripts/macos_app_bundle.sh
          tar -czf aegistrace-macos.tar.gz -C dist/macos .
          if [ -d dist/macos/AEGISTRACE.app ]; then
            tar -czf aegistrace-macos-app.tar.gz -C dist/macos AEGISTRACE.app
          fi
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            aegistrace-macos.tar.gz
            aegistrace-macos-app.tar.gz

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build Rust binaries
        run: cargo build --release -p aegis-core-server -p aegis-collector-cli -p aegis-verifier
      - name: Package
        run: |
          mkdir -p dist
          cp target/release/aegis-core-server dist/
          cp target/release/aegis-collector-cli dist/
          cp target/release/aegis-verifier dist/
          tar -czf aegistrace-linux.tar.gz -C dist .
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: aegistrace-linux.tar.gz

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build Rust binaries
        run: cargo build --release -p aegis-core-server -p aegis-collector-cli -p aegis-verifier
      - name: Package
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item -Force target/release/aegis-core-server.exe dist/
          Copy-Item -Force target/release/aegis-collector-cli.exe dist/
          Copy-Item -Force target/release/aegis-verifier.exe dist/
          Compress-Archive -Path dist/* -DestinationPath aegistrace-windows.zip
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: aegistrace-windows.zip
